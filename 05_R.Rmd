
```{r, include=FALSE, echo=FALSE}
require(knitr)
knitr::opts_chunk$set(eval=FALSE, results=TRUE, message=FALSE, warning=FALSE, error=FALSE,
                      fig.path="figures/")
# knitr::opts_knit$set(root.dir="R/Rinstall")
```

# R

After introducing simulation based power analysis in Stata and Python, we introduce how to do the same simulation in R. 

## Simple linear regression

### Setup

The main library we will use is `stats` and comes bundled with base R. However, we also need to install a couple of additional libraries onto our machine and then load them into our search path. 

```{r}
# install.packages("lmtest")
# install.packages("ggplot2")
library(lmtest)
library(ggplot2)
```

We set seed to 1024. 

```{r}
set.seed(1024)
```

### Step 1: model specification

Write down the regression model, including all variables and parameters of interest:

$$
bpsystol = \beta_0 + \beta_1(age) + \beta_2(sex) + \beta_3(age*sex) + \epsilon
$$

where the variables of interest are age, sex and the interaction of age and sex. Also, you need to estimate the coefficients for $\beta_0$, $\beta_1$, $\beta_2$, $\beta_3$.

### Step 2: Variable composition

Specify the details of the covariates, such as the range of age or the proportion of females.

### Step 3: Parameter composition

Locate or think about reasonable values for the parameters in your model.

### Steps 4-5: Simulate and automate

Next, let's write a function that creates datasets under the alternative hypothesis, fits the models, and uses a likelihood-ratio test to calculate power.

```{r}
sample_cnt <- c(400, 500, 600, 700)
interact_coef <- c(0.2, 0.25, 0.3, 0.35, 0.4)
repect_cnt <- seq(1, 1000)

power_list <- data.frame(sample_cnt=double(), interact_coef=double(), power=double())[-1,]

for (s in sample_cnt) {
  
  for (i in interact_coef){
    
    results <- c()
    
    for (r in repect_cnt){
      
      age <- ceiling(runif(s, 18, 65))
      female <- rbinom(s, 1, 0.5)
      interact <- age * female
      e <- rnorm(s, 0, 20)
      sbp <- 110 + 0.5*age + (-20)*female + i*interact + e
      
      full_model <- lm(sbp ~ age + female + interact)
      reduced_model <- lm(sbp ~ age + female)
      prob <- lrtest(full_model, reduced_model)$Pr[2]
      reject <- ifelse((prob<=0.05), 1, 0)
      
      results <- rbind(results, reject)
      
    }
    
    power_list <- rbind(power_list, data.frame(sample_cnt=s, interact_coef=i, power=mean(results)))
    
  }  
}

power_list
```

### Step 6: Summarize & visualize

Here's the table from the simulation.

```{r}
sample_cnt	interact_coef	power
400	0.20	0.268
400	0.25	0.387
400	0.30	0.550
400	0.35	0.652
400	0.40	0.782
500	0.20	0.323
500	0.25	0.484
500	0.30	0.609
500	0.35	0.746
500	0.40	0.866
600	0.20	0.402
600	0.25	0.551
600	0.30	0.726
600	0.35	0.850
600	0.40	0.923
700	0.20	0.450
700	0.25	0.600
700	0.30	0.770
700	0.35	0.885
700	0.40	0.957
```

Here's the graph from the simulation. 

```{r}
options(repr.plot.width = 15, repr.plot.height = 6)

ggplot(power_list, aes(interact_coef, power, group = sample_cnt, color = sample_cnt)) + 
  geom_line(aes(color = sample_cnt)) + 
  geom_point(size = 4) + 
  ylim(0,1)
```

![](https://github.com/hlmshtj-dan/pigo/blob/main/9.png?raw=true)


## Mixed effects model

### Setup

In mixed effects model simulation in R, we still use two external libraries.

```{r}
# install.packages("lmtest")
# install.packages("ggplot2")
library(lmtest)
library(ggplot2)
```

Set the seed to 1024.

```{r}
set.seed(1024)
```

### Step 1: model specification

Write down the regression model, including all variables and parameters of interest:

$$
weight_{it} = \beta_0 + \beta_1(age_{it}) + \beta_2(female_i) + \beta_3(age_{it}*female_i) + \mu_{0i} + \mu_{1i}(age) + \epsilon_{it}
$$

where $i$ stands for `children`, $t$ for `age`, and we assume $\mu_{0i} \sim N(0, \tau_0)$, $\mu_{1i}\sim N(0, \tau_1)$, $\epsilon_{it} \sim N(0, \sigma)$.

The covariates are `weight`, `age`, `female`, and the interaction term `age\*female`. Also, we need to estimate the coefficients for $\beta_0$ (Intercept), $\beta_1$ (coefficient for age), $\beta_2$ (coefficient for the female comparing with the male), $\beta_3$ (coefficient for the interaction), $\mu_{1i}$ (random effect of age).

We also need to think about the covariates in our model. This is a longitudinal study, so we need to specify the starting age, the length of time between measurements, and the total number of measurements. We also need to consider the proportion of males and females in our study. Are we likely to sample 50% females and 50% males?

Let's assume that we will measure the childrens' weight every 6 months for 2 years beginning at age 12. And let's also assume that the sample will be 50% female. The interaction term ageÃ—female is easy to calculate once we create variables for age and female.

### Step 2: Variable composition

Specify the details of the covariates, such as the range of age or the proportion of females.

Let's assume that we will measure the children's weight every 4 months for 4 years beginning at age 10. Also, in the sample, the proportion of female is equal to that of male. It's not difficult to calculate the iteration term when generate the variable for age and female.

### Step 3: Parameter composition

Locate or think about reasonable values for the parameters in your model. In this step, we use an external data set measuring Asian kid's data to estimate the coefficients for the above regression model, and we get $\beta_0=5.35$, $\beta_1=3.59$, $\beta_2=-0.47$, $\beta_3=-0.24$, $\tau_0=0.24$, $\tau_1=-0.57$ and $\sigma=1.17$.

```{r}
# missing code here
```

### Step 4-5: Simulate & automate

Next, let's write a function that creates datasets under the alternative hypothesis, fits the mixed effects models, tests the null hypothesis of interest, and uses a for loop to run many iterations of the function. 

```{r}
sample_cnt <- c(100, 200, 300, 400, 500)
obser_cnt <- c(5, 6)
repect_cnt <- seq(1, 1000)

power_list <- data.frame(obser=integer(), sample=integer(), power=double())

for (s in sample_cnt){
  
  for (o in obser_cnt){
    
    results <- c()
    
    for (r in repect_cnt){
      
      child <- seq(1, s)
      female <- rbinom(s, 1, 0.5)
      u_0i <- rnorm(s, 0, 0.25)
      u_1i <- rnorm(s, 0, 0.60)
      data_set <- data.frame(child = child, female = female, u_0i = u_0i, u_1i = u_1i)
      
      data_set_expand <- data_set[rep(seq(nrow(data_set)), o), 1:4]

      age <- c()
      for (obs in seq(0, (o-1)*0.5, 0.5)){
        
        age <- c(age, rep(obs, s))
        
      }

      data_set_expand <- cbind(data_set_expand, age)
      e_ij <- rnorm(s*o, 0, 1.2)
      data_set_expand <- cbind(data_set_expand, e_ij)
      data_set_expand$interact <- data_set_expand$age * data_set_expand$female
      data_set_expand$weight <- 5.35 + 3.6*data_set_expand$age + (-0.5)*data_set_expand$female + (-0.25)*data_set_expand$interact + data_set_expand$u_0i + data_set_expand$age*data_set_expand$u_1i + data_set_expand$e_ij
      
      full_model <- lm(data_set_expand$weight ~ data_set_expand$age + data_set_expand$female + data_set_expand$interact)
      reduced_model <- lm(data_set_expand$weight ~ data_set_expand$age + data_set_expand$female)
      prob <- lrtest(full_model, reduced_model)$Pr[2]
      reject <- ifelse((prob<=0.05), 1, 0)
      results <- rbind(results, reject)     
    }
    
    power_list <- rbind(power_list, data.frame(obser=o, sample=s, power=mean(results)))
    
  }
}

power_list
```

### Step 6: Summarize & visualize

The table result for the mixed effects model.

```{r}
obser	sample	power
5	100	0.323
6	100	0.401
5	200	0.505
6	200	0.651
5	300	0.680
6	300	0.815
5	400	0.780
6	400	0.897
5	500	0.845
6	500	0.951
```

The graph of the simulation result for mixed effects model.

```{r}
options(repr.plot.width = 15, repr.plot.height = 6)

ggplot(power_list, aes(sample, power, group = obser, color = obser)) + 
  geom_line(aes(colour = obser)) + 
  geom_point(size = 4) + 
  ylim(0,1)
```

![](https://github.com/hlmshtj-dan/pigo/blob/main/10.png?raw=true)
