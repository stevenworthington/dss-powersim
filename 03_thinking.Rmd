
```{r setup, include=FALSE, echo=FALSE}
pacman::p_load(tidyverse, papaja, knitr)
knitr::opts_chunk$set(eval=TRUE, results=TRUE, echo=FALSE, message=FALSE, warning=FALSE, error=FALSE, fig.height=5, fig.width=8, fig.path="figures/")
```

# (PART) Preparation {-}

# Power of what?

The first 3 steps in power simulation involve nothing more than thinking and then writing down your thoughts using a pencil and paper. But, prior to walking through these steps there is an even more fundamental issue to be addressed - the power of what?

What quantity within your model do you wish to calculate power for? Overall model goodness-of-fit, individual parameters, or a combinations of parameters? The point of entry for power analysis is always to identify the particular effect of interest, and for that you must answer the question, "power of what?".

## Study design

The study design we will use as an example throughout this tutorial comes from Julian Quandt's blogpost (<https://julianquandt.com/post/power-analysis-by-data-simulation-in-r-part-iv/>). He describes this as:

> A new hypothetical research question focused on music preference. The overarching research goal will be to - once and for all - find out whether Rock or Pop music is better. Of course, we could just ask people what they prefer, but we do not want to do that because we want a more objective measure of what is Rock and Pop (people might have different ideas about the genres). Therefore, we will have participants listen to a bunch of different songs that are either from a Spotify "best-of-pop" or "best-of-rock" playlist and have them rate the song on a evaluation scale from 0-100 points. 

## Simple linear regression

In the following implementations of power simulation in R, Python, and Stata, we will walk through a concrete example using a simple linear regression model, before moving to a more complicated example using a mixed effects model. While canned routines exist to calculate power for some simple general linear models, this exercise will serve to build intuition about the process of power simulation that will be helpful for the more complex case.

### Step 1: model specification

The first step is to write down the regression model of interest, including all variables and parameters:

$$
\textrm{liking}_i = \beta_0 + \beta_1 \times \textrm{genre}_i + \epsilon_i
$$

where $i$ stands for `song`, and we assume $\epsilon_{i} \sim \mathcal{N}(0, \sigma)$. The parameter of interest is $\beta_1$ - the average difference in the rating of songs between the two genres. 

```{r param-def, echo=FALSE, results="asis"}
tibble::tribble(~`model`, ~`code`, ~`description`,
        "$\\textrm{liking}_{ij}$", "$\\texttt{liking}$", "reaction time for subject $s$ to item $i$",
        "$\\textrm{genre}_i$", "$\\texttt{genre\\_i}$", "condition for item $i$ (-.5 = ingroup, .5 = outgroup)",
        "$\\beta_0$", "$\\texttt{beta\\_0}$", "intercept; grand mean RT",
        "$\\beta_1$", "$\\texttt{beta\\_1}$", "slope; mean effect of ingroup/outgroup", 
        "$\\sigma$", "$\\texttt{sigma}$", "standard deviation of residuals",       
        "$e_{i}$", "$\\texttt{e\\_si}$", "residual for the trial involving subject $s$ and item $i$")%>%
  apa_table(align = c("l", "l", "l"),
            caption = "Variables in the data-generating model and associated R code.",
            escape = FALSE,
            placement = "H")
```

### Step 2: Variable composition

Once we have the model equation, we need to specify the details of the covariates, such as the range of `age` or the proportion of females (`sex`). For example, the range of `age` might encompass the full range of human longevity (e.g., 0 to 120 years) or could be more focused on non-retired adults (e.g., 18 to 65 years). The proportion of females could theoretically vary anywhere in the interval (0, 1), but practically is rarely outside of the interval [0.45, 0.55].

### Step 3: Parameter composition

Finally, we need to establish the data-generating parameters in your model. You may draw on your own, or your colleague's, substantive expertise about the phenomenom you're studying to determine what paramater values are plausible. Or, you might look to the literature for studies that examined similar effects and use these as a starting point.

```{r params-all, echo=FALSE, results="asis"}
tibble::tribble(~`code`, ~`value`, ~`description`,
        "$\\texttt{beta\\_0}$", "800", "intercept; i.e., the grand mean",
        "$\\texttt{beta\\_1}$", "50", "slope; i.e, effect of category",
        "$\\texttt{sigma}$", "200", "residual (error) sd") %>%
  apa_table(align = c("l", "l", "l"),
            caption = "Settings for all data-generating parameters.",
            escape = FALSE,
            placement = "H")
```

## Mixed effects model

Our mixed effects model example will follow the same steps as the simple linear regression, but this time with data that exhibits clustering.

### Step 1: model specification

Once again, we first write down the regression model of interest, including all variables and parameters:

$$
\textrm{liking}_{ij} = \beta_0 + \mu_{0j} + (\beta_1 + \mu_{1j}) \times \textrm{genre}_i + \epsilon_{ij}
$$

where $i$ stands for `song`, $j$ for `participant`, and we assume $\mu_{0j} \sim \mathcal{N}(0, \tau_0)$, $\mu_{1j} \sim \mathcal{N}(0, \tau_1)$, $\epsilon_{ij} \sim \mathcal{N}(0, \sigma)$. 

```{r param-def-mixed, echo=FALSE, results="asis"}
tibble::tribble(~`model`, ~`code`, ~`description`,
        "$\\textrm{liking}_{ij}$", "$\\texttt{liking}$", "reaction time for subject $s$ to item $i$",
        "$\\textrm{genre}_i$", "$\\texttt{genre\\_i}$", "condition for item $i$ (-.5 = ingroup, .5 = outgroup)",
        "$\\beta_0$", "$\\texttt{beta\\_0}$", "intercept; grand mean RT",
        "$\\beta_1$", "$\\texttt{beta\\_1}$", "slope; mean effect of ingroup/outgroup",
        "$\\tau_0$", "$\\texttt{tau\\_0}$", "standard deviation of by-subject random intercepts",
        "$\\tau_1$", "$\\texttt{tau\\_1}$", "standard deviation of by-subject random slopes",        
        "$\\rho$", "$\\texttt{rho}$", "correlation between by-subject random intercepts and slopes",
        "$\\omega_0$", "$\\texttt{omega\\_0}$", "standard deviation of by-item random intercepts",
        "$\\sigma$", "$\\texttt{sigma}$", "standard deviation of residuals",
        "$T_{0s}$", "$\\texttt{T\\_0s}$", "random intercept for subject $s$",
        "$T_{1s}$", "$\\texttt{T\\_1s}$", "random slope for subject $s$",
        "$O_{0i}$", "$\\texttt{O\\_0i}$", "random intercept for item $i$",
        "$e_{si}$", "$\\texttt{e\\_si}$", "residual for the trial involving subject $s$ and item $i$") %>%
  apa_table(align = c("l", "l", "l"),
            caption = "Variables in the data-generating model and associated R code.",
            escape = FALSE,
            placement = "H")
```

### Step 2: Variable composition

We also need to think about the covariates in our model. This is a longitudinal study, so we need to specify the starting `age`, the length of time between measurements, and the total number of measurements. We also need to consider the proportion of males and females in our study. Are we likely to sample 50% females and 50% males?

Let's assume that we will measure the children's weight every 4 months for 4 years beginning at age 10. Also, let's assume that the sample will be 50% female. The interaction term (`age\*female`) is easy to calculate once we create variables for `age` and `female`. 

### Step 3: Parameter composition

Finally, we need to establish the data-generating parameters in your model. As before, you may determine what paramater values are plausible by drawing on substantive expertise about the phenomenom you're studying or by referencing the literature for studies that report similar effects.

```{r params-all-mixed, echo=FALSE, results="asis"}
tibble::tribble(~`code`, ~`value`, ~`description`,
        "$\\texttt{beta\\_0}$", "800", "intercept; i.e., the grand mean",
        "$\\texttt{beta\\_1}$", "50", "slope; i.e, effect of category",
        "$\\texttt{omega\\_0}$", "80", "by-item random intercept sd",
        "$\\texttt{tau\\_0}$", "100", "by-subject random intercept sd",
        "$\\texttt{tau\\_1}$", "40", "by-subject random slope sd",
        "$\\texttt{rho}$", "0.2", "correlation between intercept and slope",
        "$\\texttt{sigma}$", "200", "residual (error) sd") %>%
  apa_table(align = c("l", "l", "l"),
            caption = "Settings for all data-generating parameters.",
            escape = FALSE,
            placement = "H")
```
